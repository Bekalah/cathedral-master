name = "cathedral-egregore"
main = "apps/worker/src/index.ts"
compatibility_date = "2024-01-01"
compatibility_flags = ["nodejs_compat"]

[build]
command = "pnpm run build:worker"

[build.upload]
format = "service-worker"

[[build.upload.rules]]
type = "ESModule"
globs = ["**/*.js"]

[vars]
NODE_ENV = "production"
EGREGORE_MODE = "production"

[triggers]
crons = ["0 */6 * * *"]  # Every 6 hours for maintenance

[[durable_objects.bindings]]
name = "EGREGORE_WORKER_STATE"
class_name = "EgregoreWorkerState"

[[durable_objects.bindings]]
name = "CODEX_MANIFESTATION_CACHE"
class_name = "CodexManifestationCache"

[[kv_namespaces]]
binding = "EGREGORE_ASSETS"
id = "egregore_assets_namespace"
preview_id = "egregore_assets_preview"

[[kv_namespaces]]
binding = "EXTERNAL_PROJECT_CACHE"
id = "external_project_cache"
preview_id = "external_project_cache_preview"

[env.production]
routes = [
  { pattern = "bekalah.github.io/circuitum99/*", zone_name = "bekalah.github.io" }
]

[env.production.vars]
DOMAIN = "bekalah.github.io"
SUBDOMAIN = "circuitum99"