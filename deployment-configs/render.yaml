services:
  - type: web
    name: cathedral-egregore
    runtime: node
    buildCommand: pnpm install && pnpm run build:all
    startCommand: pnpm run start:production
    envVars:
      - key: NODE_ENV
        value: production
      - key: NODE_VERSION
        value: "20"
      - key: PNPM_VERSION
        value: "9.15.0"
      - key: RENDER_EXTERNAL_URL
        generateValue: true
    healthCheckPath: /health
    disk:
      name: egregore-cache
      mountPath: /opt/render/cache
      sizeGB: 10

  - type: worker
    name: egregore-file-watcher
    runtime: python3
    buildCommand: pip install -r requirements.txt
    startCommand: python packages/cosmogenesis/src/external_project_bridge.py
    envVars:
      - key: PYTHON_VERSION
        value: "3.11"
      - key: WATCHDOG_USE_POLLING
        value: "true"

databases:
  - name: egregore-db
    databaseName: egregore_manifestations
    user: egregore_user
    plan: starter

envVarGroups:
  - name: egregore-secrets
    envVars:
      - key: EGREGORE_ENCRYPTION_KEY
        generateValue: true
      - key: WEBSOCKET_SECRET
        generateValue: true
      - key: FILE_WATCHER_TOKEN
        generateValue: true
